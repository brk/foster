main = {
  arrays        !;
  arrays8       !;
};

newDArray32 = { n : Int32 => f : { Int32 => Int32 } =>
  let a = allocDArray:[Int32] n;
      x = (ref n);
   in
      until x^ ==Int32 0 then
          f x^      >^ a[x^ -Int32  1];
           (x^ -Int32 1) >^ x
      end;
    a
  end
};

arrays = {
  let a = newDArray32 2 { n : Int32 => n };
   in
      expect_i32 2;
     print_i32 a[opaquely_i32 1];
  end
};

trunc32to8 = { n : Int32 => primitive_trunc_i32_i8 n; };

newDArray8 = { n : Int32 => f : { Int32 => Int8 } =>
  let a = allocDArray:[Int8] n;
      x = (ref n);
   in
      until x^ ==Int32 0 then
          f x^           >^ a[x^ -Int32  1];
           (x^ -Int32 1) >^ x
      end;
    a
  end
};


print_text = { s : Text =>
  case s
    of $TextFragment a n     -> prim_print_bytes_stderr a 3; 0
    of $TextConcat   s1 s2 x -> 0 // print_text s1 ; print_text s2; x
   end;
};


arrays8 = {
  let a = newDArray8 26 { x : Int32 => trunc32to8 (x +Int32 96) };
   in
     expect_i32 99;
     print_i8 a[opaquely_i32 2];

     (trunc32to8 0) >^ a[3];
     prim_print_bytes_stdout a 6;
     print_abc !;
  end
};

print_abc = {
  print_text "abc";
};

