main = {
  simpler   !;
  capture   !;
  ref-if    !;
  arrays    !;
  tuprefs1  !;
  tuprefs2  !;
  ref-until !;
  hof-until !;

  expect_i1 false; print_i1 (__COMPILES__ 0 >^ 0);
  expect_i1 false; print_i1 (__COMPILES__ let r = (ref 0); in r >^ r end);
};


tuprefs1 = {
  let t = ((ref opaquely_i32 1), (ref 2)); in
    expect_i32 1;
    case t of (r, _) -> print_i32 r^ end
  end
};

tuprefs2 = {
  let r = (ref (1, 2, 3, 4)); in
    expect_i32 4;
    case r^ of (_, _, _, x) -> print_i32 x; 0 end;
    expect_i32 14;
    (11, 12, 13, 14) >^ r;
    case r^ of (_, _, _, x) -> print_i32 x; 0 end;
  end
};

simpler = {
  let r = (ref 0); in
    expect_i32 0;
     print_i32 r^;
    3 >^ r;
    expect_i32 3;
     print_i32 r^;
   end
};

capture = {
  let r = (ref 0);
      f = { r^ };
   in
     2 >^ r;
     expect_i32 2;
      print_i32 (f !);
  end
};

ref-if = {
  let r = if 2 ==Int32 (opaquely_i32 2) then (ref 0) else (ref 1) end;
  in
   expect_i32 0;
    print_i32 r^;
  end
};

newDArray32 = { n : Int32 => f : { Int32 => Int32 } =>
  let a = allocDArray:[Int32] n;
      x = (ref n);
   in
      until x^ ==Int32 0 then
          f x^      >^ a[x^ -Int32  1];
           (x^ -Int32 1) >^ x
      end;
    a
  end
};

arrays = {
  let a = newDArray32 2 { n : Int32 => n };
   in
      expect_i32 2;
     print_i32 a[opaquely_i32 1];
  end
};


hof-until-if = { c : {Bool} => b : { () } =>
  if c ! then 0 else let j0 = b !; in hof-until-if c b end
  end
};

hof-until-case = { c : {Bool} => b : { () } =>
  case c !
    of true ->  0
    of false -> let j0 = b !; in hof-until-case c b end
  end
};

hof-until = {
  let r = (ref 16);
   in expect_i32 16;
      expect_i32 15;
      expect_i32 14;
      hof-until-if   { r^ ==Int32 13 } {
                print_i32 r^; (r^ -Int32 1) >^ r;
      };
      expect_i32 13;
      expect_i32 14;
      expect_i32 15;
      hof-until-case { r^ ==Int32 16 } {
                print_i32 r^; (r^ +Int32 1) >^ r;
      };
  end
};

ref-until = {
  expect_i32 3;
  expect_i32 3;
  expect_i32 2;
  expect_i32 1;
  let r = (ref opaquely_i32 3);
   in print_i32 r^;
      until r^ ==Int32 0 then
        print_i32 r^;
        (r^ -Int32 1) >^ r;
      end
  end
};

